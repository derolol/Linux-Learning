# 文件

## 1. 文件信息包含

+ 控制信息

|类型|内容|
|:-:|-|
|基本目录项|path、i-node|
|索引节点|i-node、size、time、address table|


+ 数据


> 不同的文件系统类型索引内容有差异

Virtual File System - **VFS**（包含了virtual node）提供了统一的操作函数，用来操作不同的文件类型

文件被进程访问，无需将数据部分装入内存，仅需装入其控制信息

> open(path, 权限)的运行流程

+ 根据path查询目录，将文件对应的i-node装入内存
+ 生成与i-node对应的v-node，以统一的方式（函数）使用不同的文件系统
+ 在系统打开文件列表中新增一项，记录每个进程对文件的访问位置及权限

|系统打开文件列表|
|:-:|
|size|
|position|
|attribute|

+ 另外的进程可通过在系统表中增加一项，该项又指向相同的v-node，实现统一文件多进程共享

+ 进程打开文件列表，实质上为FILE*数组，文件描述符实际上是数组的下标

## 2. 操作控制字 O\_WRONLY | W\_CREAT| O\_APPEND

+ `|` 逻辑加
+ `O_WRONLY` 操作字

|O_WDONLY|O_RDONLY|
|:-:|:-:|
|00000001|00000010|


## 3. lseek()

+ 只移动文件的当前位置，不引起任何I/O动作
+ 文件空洞
+ 引起文件指针（读/写位置）变化，文件指针仅存在于内存中，不回写硬盘是不会影响文件大小即EOF
+ O\_APPEND 在文件EOF处对内容进行追加，lseek的操作无效

|常量|含义|
|:-:|:-:|
|SEEK\_SET|文件头|
|SEEK\_CUR|当前位置
|SEEK\_END|文件尾|

## 4. 本周指令
 
+ `od -c`
  
  以一定的格式打印文件,

+ `stat`

  打印文件的状态

## 5. 输入输出重定向

+ int dup(int old); int dup2(int old, int new);

+ 新描述子保证是当前未打开的最小编号可用描述字，新旧描述字共享同一个系统打开文件表项

+ dup 仅将old对应的进程表项复制给new，即old和new共用相同的系统表项（相同的读写位置、相同的权限等）

+ dup2 old和new原本有各自独立的系统项、v-node、i-node以及物理介质，dup2操作首先让old与之前的文件解绑，然后与new指向相同的系统表项

## 6. 同一进程打开同一个文件

> 进程打开文件列表（私有成员）

|进程打开文件列表|
|-|
|open1|
|open2|

> 系统打开文件列表（保护成员）

|系统打开文件列表|
|-|
|open1|
|open2|

  + 独立项意味着可以独立位置和方式访问文件

> v-node -> i-node -> Dev （公有成员）

  + 通过v-node实现系统打开文件列表项和i-node之间的关联

> 不同的情况

  + 进程的打开文件列表项和系统打开文件列表项一一对应 
  + 进程的多个打开文件列表项指向同一个系统打开文件列表项（通过dup和dup2可实现）

